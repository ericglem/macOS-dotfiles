# Filename:   lfrc
# Github:     https://github.com/n0ibe/macOS-dotfiles
# Maintainer: Riccardo Mazzarini

# TODO
# 1. select multiple files (even with spaces), make them executable, don't flicker and make them green
# 2. create new files with % to avoid flickering

# Basic settings {{{

# Boolean options
set color256 true
set drawbox true
set hidden true

# Integer options
set period 1

# String options
set previewer ~/.config/lf/previewer.sh
set promptfmt "\033[32;1m%u@%h\033[0m \033[34;1m%w/\033[0m\033[1m%f\033[0m"
set timefmt ''

# }}}

# Custom functions {{{

# Opener function
cmd open ${{
    case $(file -b --mime-type "$fx") in
        text/*) $EDITOR "$fx";;
        *) open "$fx" &>/dev/null;;
    esac
}}

# Create new files
cmd touch ${{
    touch "$@"
    lf -remote "send $id load"$'\n'"send $id select \"$@\""
}}

# Create new directories
cmd mkdir ${{
    mkdir -p "$@"
    lf -remote "send $id load"$'\n'"send $id select \"$@\""
}}

# Create new directory and move highlighted files into it
cmd newdir ${{
    mkdir -p "$@"
    mv $fx "$@"
    lf -remote "send $id load"$'\n'"send $id select \"$@\""
}}

# Fuzzy search a file and open it in $EDITOR
cmd fuzzy_edit ${{
    clear
    filename="$(fzf --height=80%)" && $EDITOR ~/"$filename"
}}

# Fuzzy search a directory and cd into it
cmd fuzzy_cd ${{
    clear
    dirname="$(fd . --base-directory ~ --type d --hidden --color always |
                sed "s/\[1;34m/\[1;90m/g; s/\(.*\)\[1;90m/\1\[1;34m/" |
                fzf --height=80%)" \
    && lf -remote "send $id cd ~/$dirname"
}}

# Make all the highlighted files executable
cmd make_executable %{{
    chmod +x "$fx"
}}

# Eject all the highlighted disks
cmd eject_disk %{{
    terminal-notifier -title lf -message "Ejecting ${#fx} disks..."
    diskutil eject "$fx" &>/dev/null
}}

# Set the highlighted image as wallpaper
cmd set_wallpaper %{{
    osascript -e "tell application \"Finder\" to set desktop picture to POSIX file \"$f\""
    osascript -e 'quit app "Finder"' &>/dev/null
}}

# }}}

# Key mappings {{{

# Remove some defaults
map e
map m
map n
map u
map ,
map '$'

# Mappings for built-in functions
map <enter> shell
map x cut
map d delete
map <esc> :unselect; clear

# Create files or directories
map t push :touch<space>
map k push :mkdir<space>
map D push :newdir<space>

# Fuzzy search files to edit of directories to move to
map <c-x><c-e> fuzzy_edit
map <c-x><c-d> fuzzy_cd

# Others
map + make_executable
map j eject_disk
map s set_wallpaper

# Movement
map gvl cd "/Volumes"

# }}}
